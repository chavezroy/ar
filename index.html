<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Self-Test</title>
    <style>
      :root {
        --bg: #08121f;
        --card: rgba(5, 12, 24, 0.82);
        --text: #d9ecff;
        --accent: #20e3b2;
        --warn: #ffd166;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        color: var(--text);
        background: radial-gradient(circle at 20% 20%, #15314f, var(--bg) 65%);
        overflow: hidden;
      }

      .hud {
        position: fixed;
        top: 0.75rem;
        left: 0.75rem;
        z-index: 5;
        width: min(94vw, 390px);
        background: var(--card);
        border: 1px solid rgba(217, 236, 255, 0.25);
        border-radius: 12px;
        padding: 0.9rem;
        backdrop-filter: blur(4px);
      }

      h1 {
        margin: 0 0 0.35rem 0;
        font-size: 1.05rem;
        letter-spacing: 0.02em;
      }

      p {
        margin: 0.35rem 0;
        font-size: 0.9rem;
        line-height: 1.35;
      }

      .status {
        margin-top: 0.6rem;
        padding: 0.5rem 0.6rem;
        border-radius: 8px;
        background: rgba(32, 227, 178, 0.12);
        border: 1px solid rgba(32, 227, 178, 0.4);
        color: var(--accent);
        font-weight: 600;
      }

      .hint {
        color: var(--warn);
        font-size: 0.82rem;
      }

      a {
        color: #85ccff;
      }

      a-scene {
        position: fixed !important;
        inset: 0;
      }

      video,
      canvas {
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100vw !important;
        height: 100dvh !important;
      }

      video {
        object-fit: cover;
        background: #000;
      }
    </style>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.min.js"></script>
  </head>
  <body>
    <div class="hud">
      <h1>AR Self-Test</h1>
      <p>Allow camera access, then point at a Hiro marker.</p>
      <p class="hint">
        If you need a marker, print or display one from
        <a href="https://github.com/AR-js-org/AR.js/blob/master/data/images/hiro.png" target="_blank" rel="noopener noreferrer">hiro.png</a>.
      </p>
      <div id="status" class="status">Status: Initializing camera...</div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true"
      embedded
      arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;"
    >
      <a-marker id="hiroMarker" preset="hiro">
        <a-box position="0 0.5 0" material="color: #20e3b2; opacity: 0.9;"></a-box>
        <a-text
          value="AR OK"
          align="center"
          position="0 1.2 0"
          color="#ffffff"
          scale="1.2 1.2 1.2"
        ></a-text>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
  const statusEl = document.getElementById("status");
  const marker = document.getElementById("hiroMarker");
  const scene = document.querySelector("a-scene");

  function setStatus(text, ok = true) {
    statusEl.textContent = "Status: " + text;
    statusEl.style.color = ok ? "var(--accent)" : "var(--warn)";
    statusEl.style.borderColor = ok
      ? "rgba(32, 227, 178, 0.4)"
      : "rgba(255, 209, 102, 0.55)";
    statusEl.style.background = ok
      ? "rgba(32, 227, 178, 0.12)"
      : "rgba(255, 209, 102, 0.12)";
  }

  let cameraStarted = false;

  function markCameraStarted() {
    if (cameraStarted) return;
    cameraStarted = true;
    setStatus("Camera is on. Point at Hiro marker to test.");
  }

  marker.addEventListener("markerFound", () => {
    setStatus("Marker detected. AR tracking works.");
  });

  marker.addEventListener("markerLost", () => {
    setStatus("Marker lost. Re-center marker in view.", false);
  });

  if (window.location.protocol === "file:") {
    setStatus("Camera access is blocked on file://. Run from localhost or HTTPS.", false);
  }

  function getArToolkitSource() {
    const arSystem = scene?.systems?.arjs;
    return arSystem?._arToolkitSource || arSystem?.arToolkitSource || null;
  }

  function normalizeVideoForIOS() {
    const video = document.querySelector("video");
    if (!video) return;
    video.setAttribute("playsinline", "");
    video.setAttribute("webkit-playsinline", "");
    video.muted = true;
  }

  function forceArResize() {
    const source = getArToolkitSource();
    const rendererCanvas = scene?.renderer?.domElement;
    if (!source || !rendererCanvas) return;

    try {
      source.onResizeElement();
      source.copyElementSizeTo(rendererCanvas);
      if (source.arController && source.arController.canvas) {
        source.copyElementSizeTo(source.arController.canvas);
      }
    } catch (_err) {
      // Keep silent; this may run before AR.js source is fully initialized.
    }
  }

  // AR.js/A-Frame event hooks (different builds emit on different targets)
  [window, document, scene].forEach((target) => {
    if (!target || !target.addEventListener) return;

    target.addEventListener("arjs-video-loaded", markCameraStarted);
    target.addEventListener("camera-init", markCameraStarted);
    target.addEventListener("loaded", () => {
      // Fallback: detect the injected webcam video element becoming active.
      setTimeout(() => {
        normalizeVideoForIOS();
        forceArResize();
        const video = document.querySelector("video");
        if (video && video.readyState >= 2) {
          markCameraStarted();
        }
      }, 300);
    });
    target.addEventListener("camera-error", (event) => {
      const message = event?.detail?.message || "Camera error. Check browser/site camera permissions.";
      setStatus(message, false);
    });
  });

  function handleViewportChange() {
    // iOS can report stale viewport values right after rotation; retry a few times.
    [0, 250, 700].forEach((delayMs) => {
      setTimeout(() => {
        normalizeVideoForIOS();
        forceArResize();
      }, delayMs);
    });
  }

  window.addEventListener("resize", handleViewportChange);
  window.addEventListener("orientationchange", handleViewportChange);

  // Poll as final fallback for browsers that skip expected custom events.
  let checks = 0;
  const checkTimer = setInterval(() => {
    checks += 1;
    const video = document.querySelector("video");
    const running =
      video &&
      video.srcObject &&
      video.srcObject.getVideoTracks().some((t) => t.readyState === "live");

    if (running) {
      normalizeVideoForIOS();
      forceArResize();
      markCameraStarted();
      clearInterval(checkTimer);
      return;
    }

    if (checks >= 12 && !cameraStarted) {
      setStatus("Waiting for camera permission or camera startup...", false);
      clearInterval(checkTimer);
    }
  }, 1000);
</script>
  </body>
</html>
